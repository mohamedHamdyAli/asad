import{m as S,r as C,i as J,p as b,q as se,c as U,o as d,w as z,b as i,a as $,u as x,h as m,f,t as h,F as le,s as ie,j as G,k as H}from"./app-unPPlrTv.js";import{_ as re}from"./AuthenticatedLayout-WDK6EzOR.js";import{_ as ne}from"./UnitNav-BggN1prt.js";import{F as K,a as oe}from"./FolderPicker-RG-apjOE.js";import{c as V,a as de,b as N,f as Q,F as ue,E,d as W}from"./index.esm-nJk38Dwr.js";import{_ as ce}from"./_plugin-vue_export-helper-DlAUqK2U.js";function fe(e){try{return typeof e=="string"?JSON.parse(e):e}catch{return e}}function pe(e){var n;return Array.isArray(e)?e:Array.isArray(e==null?void 0:e.data)?e.data:Array.isArray(e==null?void 0:e.message)?e.message:Array.isArray((n=e==null?void 0:e.data)==null?void 0:n.data)?e.data.data:[]}function me(e){return e?`/storage/${e}`:""}function _e(e){return(e||"").split("/").pop()||""}function ge(e){return/\.pdf$/i.test(e||"")}function he(e={}){const n=fe(e.title),o=n&&typeof n=="object"?n:{en:n??"",ar:n??""},s=me(e.file);return{id:e.id,unit_id:e.unit_id,folder_id:e.folder_id,file:e.file??"",file_url:s,file_name:_e(e.file),is_pdf:ge(e.file),title_en:o.en??"",title_ar:o.ar??"",created_at:e.created_at,updated_at:e.updated_at}}const j={list:async e=>{const{data:n}=await S.get(`/api/unit-docs/${e}`);return pe(n).map(he)},create:async e=>{const{data:n}=await S.post("/api/unit-docs/create",e,{headers:{"Content-Type":"multipart/form-data"}});return n},update:async e=>{const{data:n}=await S.post("/api/unit-docs/update",e,{headers:{"Content-Type":"multipart/form-data"}});return n},remove:async e=>{const{data:n}=await S.delete(`/api/unit-docs/delete/${e}`);return n}};function ve(e,n=[]){const o=new FormData;return o.append("unit_id",String(e)),n.forEach((s,c)=>{var y,_;o.append(`data[${c}][folder_id]`,String(s.folder_id??"")),o.append(`data[${c}][title][en]`,((y=s==null?void 0:s.title)==null?void 0:y.en)??""),o.append(`data[${c}][title][ar]`,((_=s==null?void 0:s.title)==null?void 0:_.ar)??""),s.file&&o.append(`data[${c}][file]`,s.file)}),o}function be(e,n=[]){const o=new FormData;return o.append("unit_id",String(e)),n.forEach((s,c)=>{var y,_;o.append(`data[${c}][id]`,String(s.id??"")),o.append(`data[${c}][folder_id]`,String(s.folder_id??"")),((y=s==null?void 0:s.title)==null?void 0:y.en)!==void 0&&o.append(`data[${c}][title][en]`,s.title.en??""),((_=s==null?void 0:s.title)==null?void 0:_.ar)!==void 0&&o.append(`data[${c}][title][ar]`,s.title.ar??""),s.file&&o.append(`data[${c}][file]`,s.file)}),o}const xe={class:"p-6 space-y-6"},ye={class:"flex items-center justify-between"},ke=["href"],we={class:"bg-white p-4 rounded shadow"},$e={class:"grid grid-cols-1 md:grid-cols-3 gap-4"},Fe={class:"mt-4"},Ae=["onChange"],Ue={key:1,class:"mt-3 text-sm text-gray-600"},De={class:"mt-4 flex items-center gap-3"},qe=["disabled"],Ie={key:0,class:"text-red-600 text-sm"},Se={class:"bg-white p-5 rounded-2xl shadow-sm ring-1 ring-black/[0.05]"},Ce={key:0,class:"text-sm text-gray-500"},Ve={key:1,class:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-5"},Ne={class:"relative aspect-[4/3] bg-gray-50 flex items-center justify-center"},Ee=["src"],je={key:1,class:"flex flex-col items-center text-gray-500 text-xs"},Te={class:"mt-2 break-all max-w-[90%]"},Re=["href"],Be={class:"p-3.5 space-y-3 text-sm"},Le=["onUpdate:modelValue"],Pe={key:0,class:"error"},Me=["onUpdate:modelValue"],Oe={key:0,class:"error"},Je={key:0,class:"error"},ze={class:"text-[11px]"},Ge=["onChange"],He={key:0,class:"mt-1 text-[11px] text-gray-500"},Ke={class:"flex items-center gap-2 pt-2"},Qe=["onClick","disabled"],We=["onClick"],Xe={key:0,class:"col-span-full text-center text-gray-500 py-8"},Ye={__name:"Docs",props:{unitId:{type:[Number,String],required:!0}},setup(e){const n=V({folder_id:Q().required("Folder is required"),title:V({en:N().required("English title is required"),ar:N().required("Arabic title is required")}),files:de().nullable().test("required","Please select at least one file",l=>Array.isArray(l)&&l.length>0)}),o=V({folder_id:Q().required("Folder is required"),title:V({en:N().required("English title is required"),ar:N().required("Arabic title is required")})}),s=C({}),c=e,y=J(()=>"/units-management"),_=b([]),L=b(!1);async function T(){L.value=!0;try{_.value=await oe.list("document",c.unitId)}finally{L.value=!1}}function P(l){_.value.unshift(l)}const k=b({folder_id:null,title:{en:"",ar:""},files:[]}),F=b([]),D=b(!1),q=b("");J(()=>{var l,t;return!!k.value.folder_id&&!!((l=k.value.title.en)!=null&&l.trim())&&!!((t=k.value.title.ar)!=null&&t.trim())&&F.value.length>0});function X(l,t){const a=Array.from(l.target.files||[]);F.value=a,t("files",a)}async function Y(l){var t,a;D.value=!0,q.value="";try{const r=l.files.map(g=>({folder_id:l.folder_id,title:{...l.title},file:g})),u=ve(c.unitId,r);await j.create(u),await A(),F.value=[],k.value.title={en:"",ar:""}}catch(r){console.error(r),q.value=((a=(t=r==null?void 0:r.response)==null?void 0:t.data)==null?void 0:a.message)||(r==null?void 0:r.message)||"Upload failed"}finally{D.value=!1}}const R=b([]),B=b(!1),v=C({}),w=C({}),I=C({});function Z(l){l.forEach(t=>{v[t.id]={folder_id:t.folder_id??null,title:{en:t.title_en||"",ar:t.title_ar||""}}})}function M(l){const t=l==null?void 0:l.target;t&&(t.style.height="auto",t.style.height=`${t.scrollHeight}px`)}async function A(){B.value=!0;try{const l=await j.list(c.unitId);R.value=l,Z(l)}finally{B.value=!1}}function ee(l,t){var r;const a=((r=t.target.files)==null?void 0:r[0])||null;a&&(w[l]=a)}async function te(l){var a,r;const t=v[l];if(t){s[l]={};try{await o.validate(t,{abortEarly:!1})}catch(u){u.inner.forEach(g=>{s[l][g.path]=g.message});return}I[l]=!0;try{const u=[{id:l,folder_id:t.folder_id,title:t.title||{en:"",ar:""},file:w[l]}],g=be(c.unitId,u);await j.update(g),delete w[l],await A()}catch(u){console.error(u),alert(((r=(a=u==null?void 0:u.response)==null?void 0:a.data)==null?void 0:r.message)||"Update failed")}finally{I[l]=!1}}}async function ae(l){confirm("Delete this document?")&&(await j.remove(l),await A())}return se(async()=>{await T(),await A()}),(l,t)=>(d(),U(re,null,{default:z(()=>[i("div",xe,[i("div",ye,[t[2]||(t[2]=i("h2",{class:"text-2xl font-bold text-dash-title"},"Unit Documents",-1)),i("a",{href:y.value,class:"px-3 py-1 border rounded text-black"},"Back to Units",8,ke)]),$(ne,{"unit-id":Number(e.unitId),cols:2},null,8,["unit-id"]),$(x(ue),{"validation-schema":x(n),"validate-on-mount":!1,"initial-values":k.value,onSubmit:Y},{default:z(({setFieldValue:a,submitCount:r})=>[i("div",we,[t[5]||(t[5]=i("h3",{class:"text-lg font-bold mb-3"},"Add Documents",-1)),i("div",$e,[i("div",null,[$(K,{type:"document",label:"Folder *","model-value":k.value.folder_id,options:_.value,unitId:c.unitId,"onUpdate:modelValue":u=>{k.value.folder_id=u,a("folder_id",u)},onCreated:P,onRefresh:T},null,8,["model-value","options","unitId","onUpdate:modelValue"]),r>0?(d(),U(x(E),{key:0,name:"folder_id",class:"error"})):m("",!0)]),i("div",null,[t[3]||(t[3]=i("label",{class:"block text-xs text-gray-500 mb-1"},"Title (EN) *",-1)),$(x(W),{name:"title.en",class:"form-input"}),r>0?(d(),U(x(E),{key:0,name:"title.en",class:"error"})):m("",!0)]),i("div",null,[t[4]||(t[4]=i("label",{class:"block text-xs text-gray-500 mb-1"},"Title (AR) *",-1)),$(x(W),{name:"title.ar",class:"form-input"}),r>0?(d(),U(x(E),{key:0,name:"title.ar",class:"error"})):m("",!0)])]),i("div",Fe,[i("input",{type:"file",multiple:"",onChange:u=>X(u,a)},null,40,Ae),r>0?(d(),U(x(E),{key:0,name:"files",class:"error"})):m("",!0),F.value.length?(d(),f("div",Ue,h(F.value.length)+" file(s) selected ",1)):m("",!0)]),i("div",De,[i("button",{type:"submit",disabled:D.value,class:"px-4 py-2 bg-black text-white rounded hover:bg-gray-700"},h(D.value?"Uploadingâ€¦":"Upload"),9,qe),q.value?(d(),f("span",Ie,h(q.value),1)):m("",!0)])])]),_:1},8,["validation-schema","initial-values"]),i("div",Se,[i("div",{class:"flex items-center justify-between mb-4"},[t[6]||(t[6]=i("h3",{class:"text-lg font-semibold text-gray-800"},"Documents",-1)),i("button",{onClick:A,class:"px-3 py-1.5 text-sm border rounded-lg hover:bg-gray-50"}," Refresh ")]),B.value?(d(),f("div",Ce,"Loadingâ€¦")):(d(),f("div",Ve,[(d(!0),f(le,null,ie(R.value,a=>{var r,u,g,O;return d(),f("div",{key:a.id,class:"group rounded-2xl overflow-hidden bg-white border border-gray-200/70 shadow-[0_1px_2px_rgba(0,0,0,0.04)] hover:shadow-[0_8px_24px_rgba(0,0,0,0.08)] hover:-translate-y-0.5 transition-all duration-200"},[i("div",Ne,[a.file_url&&/\.(jpg|jpeg|png|gif|webp)$/i.test(a.file_url)?(d(),f("img",{key:0,src:a.file_url,class:"absolute inset-0 w-full h-full object-cover",alt:"Document Preview"},null,8,Ee)):(d(),f("div",je,[t[7]||(t[7]=i("div",{class:"text-4xl"},"ðŸ“„",-1)),i("span",Te,h(a.file_name),1),a.file_url?(d(),f("a",{key:0,href:a.file_url,target:"_blank",class:"mt-2 px-2 py-1 border rounded text-xs hover:bg-gray-100"}," Open ",8,Re)):m("",!0)]))]),i("div",Be,[i("div",null,[t[8]||(t[8]=i("label",{class:"block text-[11px] text-gray-500 mb-1"},"Title (EN)",-1)),G(i("textarea",{"onUpdate:modelValue":p=>v[a.id].title.en=p,class:"form-input !h-auto min-h-9",rows:"1",onInput:t[0]||(t[0]=p=>M(p))},null,40,Le),[[H,v[a.id].title.en]]),(r=s==null?void 0:s[a.id])!=null&&r["title.en"]?(d(),f("p",Pe,h(s[a.id]["title.en"]),1)):m("",!0)]),i("div",null,[t[9]||(t[9]=i("label",{class:"block text-[11px] text-gray-500 mb-1"},"Title (AR)",-1)),G(i("textarea",{"onUpdate:modelValue":p=>v[a.id].title.ar=p,class:"form-input !h-auto min-h-9",rows:"1",dir:"rtl",onInput:t[1]||(t[1]=p=>M(p))},null,40,Me),[[H,v[a.id].title.ar]]),(u=s==null?void 0:s[a.id])!=null&&u["title.ar"]?(d(),f("p",Oe,h(s[a.id]["title.ar"]),1)):m("",!0)]),$(K,{type:"document",label:"Folder *",modelValue:v[a.id].folder_id,"onUpdate:modelValue":p=>v[a.id].folder_id=p,options:_.value,unitId:c.unitId,onCreated:P,onRefresh:T},null,8,["modelValue","onUpdate:modelValue","options","unitId"]),(g=s==null?void 0:s[a.id])!=null&&g.folder_id?(d(),f("p",Je,h(s[a.id].folder_id),1)):m("",!0),i("div",ze,[t[10]||(t[10]=i("label",{class:"block text-gray-500 mb-1"},"Replace File",-1)),i("input",{type:"file",onChange:p=>ee(a.id,p)},null,40,Ge),w!=null&&w[a.id]?(d(),f("p",He," Selected: "+h((O=w[a.id])==null?void 0:O.name),1)):m("",!0)]),i("div",Ke,[i("button",{class:"px-3 py-1.5 text-sm rounded-lg border border-gray-300 bg-white hover:bg-gray-50 disabled:opacity-50",onClick:p=>te(a.id),disabled:I[a.id]},h(I[a.id]?"Savingâ€¦":"Save"),9,Qe),i("button",{class:"px-3 py-1.5 text-sm rounded-lg border border-red-200 text-red-700 bg-red-50 hover:bg-red-100",onClick:p=>ae(a.id)}," Delete ",8,We)])])])}),128)),R.value.length?m("",!0):(d(),f("div",Xe," No documents found. "))]))])])]),_:1}))}},it=ce(Ye,[["__scopeId","data-v-b6324766"]]);export{it as default};
