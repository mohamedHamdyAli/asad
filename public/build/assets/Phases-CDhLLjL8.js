import{m as q,r as V,i as Q,p as h,q as W,c as U,o as n,w as N,b as s,a as g,u as y,f as u,h as f,F as C,s as D,t as b,n as X,j as $,y as Y,k as R}from"./app-b49FIgF_.js";import{_ as Z}from"./AuthenticatedLayout-CXpuQU13.js";import{_ as ee}from"./UnitNav-DRGj3u9W.js";import{c as P,b as v,F as te,d as F,E as I}from"./index.esm-BU1ouKGs.js";import{_ as se}from"./_plugin-vue_export-helper-DlAUqK2U.js";const z=[{value:"site_handover",label:"Site Handover"},{value:"fondation",label:"Skeleton"},{value:"finishing",label:"Finishing"},{value:"handover",label:"Handover"}];function ae(e){try{return typeof e=="string"?JSON.parse(e):e}catch{return e}}function ie(e){var r;return Array.isArray(e)?e:Array.isArray(e==null?void 0:e.data)?e.data:Array.isArray(e==null?void 0:e.message)?e.message:Array.isArray((r=e==null?void 0:e.data)==null?void 0:r.data)?e.data.data:[]}function re(e={}){var i;const r=ae(e.description),d=r&&typeof r=="object"?r:{en:r??"",ar:r??""};return{id:e.id,unit_id:e.unit_id,status:e.status,status_label:((i=z.find(c=>c.value===e.status))==null?void 0:i.label)||e.status,desc_en:d.en??"",desc_ar:d.ar??"",created_at:e.created_at,updated_at:e.updated_at}}const _={statuses:()=>z,list:async e=>{const{data:r}=await q.get(`/api/unit-phase/${e}`);return ie(r).map(re)},create:async e=>{const{data:r}=await q.post("/api/unit-phase/create",e);return r},update:async e=>{const{data:r}=await q.post("/api/unit-phase/update",e);return r},remove:async e=>{const{data:r}=await q.delete(`/api/unit-phase/delete/${e}`);return r}};function ne(e,r=[]){return{unit_id:e,data:r.map(d=>{var i,c;return{status:d.status,description:{en:((i=d.description)==null?void 0:i.en)??"",ar:((c=d.description)==null?void 0:c.ar)??""}}})}}function oe(e,r=[]){return{unit_id:e,data:r.map(d=>{var c,k;const i={id:d.id};return d.status!==void 0&&(i.status=d.status),d.description&&(i.description={en:((c=d.description)==null?void 0:c.en)??"",ar:((k=d.description)==null?void 0:k.ar)??""}),i})}}const de={class:"p-6 space-y-8"},le={class:"flex items-center justify-between"},ue=["href"],ce={class:"bg-white p-6 rounded-2xl shadow"},me={class:"grid grid-cols-1 md:grid-cols-3 gap-4 items-start text-sm"},pe=["value"],ye={class:"mt-4 flex justify-end gap-3"},be=["disabled"],fe={key:0,class:"text-sm text-red-600 mt-3"},ve={class:"bg-white p-6 rounded-2xl shadow"},xe={key:0,class:"text-sm text-gray-500"},he={key:1},ge={key:0,class:"text-center text-gray-500 py-10"},_e={key:1,class:"space-y-5"},ke={class:"flex items-center justify-center mb-4"},Se={class:"inline-flex items-center justify-center rounded-full bg-blue-50 text-blue-700 px-2.5 py-0.5 text-[13px] border border-blue-200"},we={class:"grid grid-cols-1 md:grid-cols-3 gap-4 text-sm"},Ae=["onUpdate:modelValue"],qe=["value"],Ue={key:0,class:"error"},Pe=["onUpdate:modelValue"],je={key:0,class:"error"},Ee=["onUpdate:modelValue"],Ve={key:0,class:"error"},Ne={class:"mt-4 flex justify-end"},Ce=["disabled","onClick"],De=["onClick"],$e={__name:"Phases",props:{unitId:{type:[Number,String],required:!0}},setup(e){const r=P({status:v().required("Status is required"),description:P({en:v().required("English description is required"),ar:v().required("Arabic description is required")})}),d=P({status:v().required("Status is required"),description:P({en:v().required("English description is required"),ar:v().required("Arabic description is required")})}),i=V({}),c=e,k=Q(()=>"/units-management"),T=_.statuses(),B=h({status:"",description:{en:"",ar:""}}),S=h(!1),w=h("");async function H(o){var t,a;S.value=!0,w.value="";try{const l=ne(c.unitId,[o]);await _.create(l),await x(),B.value={status:"",description:{en:"",ar:""}}}catch(l){w.value=((a=(t=l==null?void 0:l.response)==null?void 0:t.data)==null?void 0:a.message)||"Save failed"}finally{S.value=!1}}const j=h([]),p=V({}),A=V({}),E=h(!1);function J(o){Object.keys(p).forEach(t=>delete p[t]),o.forEach(t=>{p[t.id]={status:t.status,description:{en:t.desc_en||"",ar:t.desc_ar||""}}})}async function x(){E.value=!0;try{const o=await _.list(c.unitId);j.value=o,J(o)}finally{E.value=!1}}async function G(o){const t=p[o];if(t){i[o]={};try{await d.validate(t,{abortEarly:!1})}catch(a){a.inner.forEach(l=>{i[o][l.path]=l.message});return}A[o]=!0;try{const a=oe(c.unitId,[{id:o,status:t.status,description:t.description}]);await _.update(a),await x()}finally{A[o]=!1}}}async function K(o){confirm("Delete this phase?")&&(await _.remove(o),await x())}return W(x),(o,t)=>(n(),U(Z,null,{default:N(()=>[s("div",de,[s("div",le,[t[0]||(t[0]=s("h2",{class:"text-2xl font-bold text-gray-800"},"Project Phases",-1)),s("a",{href:k.value,class:"px-3 py-1 border rounded text-gray-700 hover:bg-gray-100"}," ← Back to Projects ",8,ue)]),g(ee,{"unit-id":Number(e.unitId),cols:2},null,8,["unit-id"]),g(y(te),{"validation-schema":y(r),"validate-on-mount":!1,"initial-values":B.value,onSubmit:H},{default:N(({submitCount:a})=>[s("div",ce,[t[5]||(t[5]=s("h3",{class:"text-lg font-semibold text-gray-800 mb-4"}," Add / Upsert Phase ",-1)),s("div",me,[s("div",null,[t[2]||(t[2]=s("label",{class:"block text-xs text-gray-500 mb-1"},"Status *",-1)),g(y(F),{as:"select",name:"status",class:"form-input"},{default:N(()=>[t[1]||(t[1]=s("option",{value:"",disabled:""},"Select status",-1)),(n(!0),u(C,null,D(y(T),l=>(n(),u("option",{key:l.value,value:l.value},b(l.label),9,pe))),128))]),_:1}),a>0?(n(),U(y(I),{key:0,name:"status",class:"error"})):f("",!0)]),s("div",null,[t[3]||(t[3]=s("label",{class:"block text-xs text-gray-500 mb-1"},"Description (EN) *",-1)),g(y(F),{as:"textarea",name:"description.en",class:"form-input min-h-[60px]"}),a>0?(n(),U(y(I),{key:0,name:"description.en",class:"error"})):f("",!0)]),s("div",null,[t[4]||(t[4]=s("label",{class:"block text-xs text-gray-500 mb-1"},"Description (AR) *",-1)),g(y(F),{as:"textarea",name:"description.ar",class:"form-input min-h-[60px]",dir:"rtl"}),a>0?(n(),U(y(I),{key:0,name:"description.ar",class:"error"})):f("",!0)]),s("div",ye,[s("button",{type:"submit",disabled:S.value,class:"w-full px-4 py-2 bg-black text-white rounded hover:bg-gray-700"},b(S.value?"Saving…":"Save Phase"),9,be)])]),w.value?(n(),u("div",fe,b(w.value),1)):f("",!0)])]),_:1},8,["validation-schema","initial-values"]),s("div",ve,[s("div",{class:"flex items-center justify-between mb-4"},[t[6]||(t[6]=s("h3",{class:"text-lg font-semibold text-gray-800"},"Existing Phases",-1)),s("button",{onClick:x,class:"px-3 py-1.5 text-sm border rounded-lg hover:bg-gray-50"}," Refresh ")]),E.value?(n(),u("div",xe,"Loading…")):(n(),u("div",he,[j.value.length?(n(),u("div",_e,[(n(!0),u(C,null,D(j.value,(a,l)=>{var L,M,O;return n(),u("div",{key:a.id,class:X(["rounded-xl p-5 border shadow-sm hover:shadow-md transition bg-white",l===0?"border-yellow-400":"border-gray-200"])},[s("div",ke,[s("span",Se,b(a.status_label),1)]),s("div",we,[s("div",null,[t[7]||(t[7]=s("label",{class:"block text-[11px] text-gray-500 mb-1"},"Status *",-1)),$(s("select",{"onUpdate:modelValue":m=>p[a.id].status=m,class:"form-input"},[(n(!0),u(C,null,D(y(T),m=>(n(),u("option",{key:m.value,value:m.value},b(m.label),9,qe))),128))],8,Ae),[[Y,p[a.id].status]]),(L=i==null?void 0:i[a.id])!=null&&L.status?(n(),u("p",Ue,b(i[a.id].status),1)):f("",!0)]),s("div",null,[t[8]||(t[8]=s("label",{class:"block text-[11px] text-gray-500 mb-1"},"Description (EN)",-1)),$(s("textarea",{"onUpdate:modelValue":m=>p[a.id].description.en=m,class:"form-input min-h-[60px]"},null,8,Pe),[[R,p[a.id].description.en]]),(M=i==null?void 0:i[a.id])!=null&&M["description.en"]?(n(),u("p",je,b(i[a.id]["description.en"]),1)):f("",!0)]),s("div",null,[t[9]||(t[9]=s("label",{class:"block text-[11px] text-gray-500 mb-1"},"Description (AR)",-1)),$(s("textarea",{"onUpdate:modelValue":m=>p[a.id].description.ar=m,class:"form-input min-h-[60px]",dir:"rtl"},null,8,Ee),[[R,p[a.id].description.ar]]),(O=i==null?void 0:i[a.id])!=null&&O["description.ar"]?(n(),u("p",Ve,b(i[a.id]["description.ar"]),1)):f("",!0)])]),s("div",Ne,[s("button",{class:"px-4 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50 disabled:opacity-60",disabled:A[a.id],onClick:m=>G(a.id)},b(A[a.id]?"Saving…":"Save Changes"),9,Ce),s("button",{class:"px-3 py-1.5 text-sm rounded-lg border border-red-200 text-red-600 bg-red-50 hover:bg-red-100 ml-3",onClick:m=>K(a.id)}," Delete ",8,De)])],2)}),128))])):(n(),u("div",ge," No phases found. "))]))])])]),_:1}))}},Me=se($e,[["__scopeId","data-v-2e4a6f73"]]);export{Me as default};
