import{m as k,i as E,p as g,r as P,q as O,c as H,o as u,w as M,b as s,f as c,h as R,j as f,F as A,s as C,u as D,t as b,y as I,k as w}from"./app-DucLZU7F.js";import{_ as q}from"./AuthenticatedLayout-Cuai63CQ.js";import{_ as J}from"./_plugin-vue_export-helper-DlAUqK2U.js";const N=[{value:"site_handover",label:"Site Handover"},{value:"fondation",label:"Foundation"},{value:"finishing",label:"Finishing"},{value:"handover",label:"Handover"}];function z(e){try{return typeof e=="string"?JSON.parse(e):e}catch{return e}}function G(e){var n;return Array.isArray(e)?e:Array.isArray(e==null?void 0:e.data)?e.data:Array.isArray(e==null?void 0:e.message)?e.message:Array.isArray((n=e==null?void 0:e.data)==null?void 0:n.data)?e.data.data:[]}function K(e={}){var d;const n=z(e.description),l=n&&typeof n=="object"?n:{en:n??"",ar:n??""};return{id:e.id,unit_id:e.unit_id,status:e.status,status_label:((d=N.find(o=>o.value===e.status))==null?void 0:d.label)||e.status,desc_en:l.en??"",desc_ar:l.ar??"",created_at:e.created_at,updated_at:e.updated_at}}const x={statuses:()=>N,list:async e=>{const{data:n}=await k.get(`/api/unit-phase/${e}`);return G(n).map(K)},create:async e=>{const{data:n}=await k.post("/api/unit-phase/create",e);return n},update:async e=>{const{data:n}=await k.post("/api/unit-phase/update",e);return n},remove:async e=>{const{data:n}=await k.delete(`/api/unit-phase/delete/${e}`);return n}};function Q(e,n=[]){return{unit_id:e,data:n.map(l=>{var d,o;return{status:l.status,description:{en:((d=l.description)==null?void 0:d.en)??"",ar:((o=l.description)==null?void 0:o.ar)??""}}})}}function W(e,n=[]){return{unit_id:e,data:n.map(l=>{var o,v;const d={id:l.id};return l.status!==void 0&&(d.status=l.status),l.description&&(d.description={en:((o=l.description)==null?void 0:o.en)??"",ar:((v=l.description)==null?void 0:v.ar)??""}),d})}}const X={class:"p-6 space-y-6"},Y={class:"flex items-center justify-between"},Z=["href"],tt={class:"bg-white p-4 rounded shadow"},et={class:"grid grid-cols-1 md:grid-cols-4 gap-4"},st={class:"md:col-span-1"},at=["value"],nt={class:"flex items-end"},it=["disabled"],ot={key:0,class:"mt-2 text-sm text-red-600"},rt={class:"bg-white p-5 rounded-2xl shadow-sm ring-1 ring-black/[0.05]"},lt={key:0,class:"text-sm text-gray-500"},dt={key:1},ut={key:0,class:"text-center text-gray-500 py-8"},ct={key:1,class:"grid grid-cols-1 lg:grid-cols-2 gap-5"},pt={class:"flex items-center justify-between mb-3"},vt={class:"font-semibold text-sm"},bt={class:"text-gray-500"},mt={class:"inline-flex items-center rounded-full bg-blue-50 text-blue-700 px-2.5 py-0.5 text-[11px] border border-blue-200"},ft=["onClick"],yt={class:"grid grid-cols-1 md:grid-cols-3 gap-3 text-sm"},gt=["onUpdate:modelValue"],xt=["value"],_t=["onUpdate:modelValue"],ht=["onUpdate:modelValue"],kt={class:"mt-4"},wt=["disabled","onClick"],St={__name:"Phases",props:{unitId:{type:[Number,String],required:!0}},setup(e){const n=e,l=E(()=>"/units-management"),d=x.statuses(),o=g({status:"",description:{en:"",ar:""}}),v=g(!1),_=g(""),j=E(()=>{var i,t;return!!o.value.status&&!!((i=o.value.description.en)!=null&&i.trim())&&!!((t=o.value.description.ar)!=null&&t.trim())});async function T(){var i,t;v.value=!0,_.value="";try{const a=Q(n.unitId,[o.value]);await x.create(a),await y(),o.value={status:"",description:{en:"",ar:""}}}catch(a){console.error(a),_.value=((t=(i=a==null?void 0:a.response)==null?void 0:i.data)==null?void 0:t.message)||(a==null?void 0:a.message)||"Save failed"}finally{v.value=!1}}const S=g([]),U=g(!1),p=P({}),h=P({});function $(i){B(),i.forEach(t=>{p[t.id]={status:t.status,description:{en:t.desc_en||"",ar:t.desc_ar||""}}})}function B(){Object.keys(p).forEach(i=>delete p[i])}async function y(){U.value=!0;try{const i=await x.list(n.unitId);S.value=i,$(i)}finally{U.value=!1}}function V(i){const t=i==null?void 0:i.target;t&&(t.style.height="auto",t.style.height=`${t.scrollHeight}px`)}async function F(i){var a,r;const t=p[i];if(t){h[i]=!0;try{const m=W(n.unitId,[{id:i,status:t.status,description:t.description}]);await x.update(m),await y()}catch(m){console.error(m),alert(((r=(a=m==null?void 0:m.response)==null?void 0:a.data)==null?void 0:r.message)||"Update failed")}finally{h[i]=!1}}}async function L(i){confirm("Delete this phase?")&&(await x.remove(i),await y())}return O(y),(i,t)=>(u(),H(q,null,{default:M(()=>[s("div",X,[s("div",Y,[t[5]||(t[5]=s("h2",{class:"text-2xl font-bold text-gray-800"},"Unit Phases",-1)),s("a",{href:l.value,class:"px-3 py-1 border rounded"},"Back to Units",8,Z)]),s("div",tt,[t[10]||(t[10]=s("h3",{class:"text-lg font-bold mb-3"},"Add / Upsert Phase",-1)),s("div",et,[s("div",st,[t[7]||(t[7]=s("label",{class:"block text-xs text-gray-500 mb-1"},"Status *",-1)),f(s("select",{"onUpdate:modelValue":t[0]||(t[0]=a=>o.value.status=a),class:"form-input"},[t[6]||(t[6]=s("option",{value:"",disabled:""},"Select status",-1)),(u(!0),c(A,null,C(D(d),a=>(u(),c("option",{key:a.value,value:a.value},b(a.label),9,at))),128))],512),[[I,o.value.status]])]),s("div",null,[t[8]||(t[8]=s("label",{class:"block text-xs text-gray-500 mb-1"},"Description (EN) *",-1)),f(s("textarea",{"onUpdate:modelValue":t[1]||(t[1]=a=>o.value.description.en=a),type:"text",class:"form-input"},null,512),[[w,o.value.description.en]])]),s("div",null,[t[9]||(t[9]=s("label",{class:"block text-xs text-gray-500 mb-1"},"Description (AR) *",-1)),f(s("textarea",{"onUpdate:modelValue":t[2]||(t[2]=a=>o.value.description.ar=a),type:"text",class:"form-input"},null,512),[[w,o.value.description.ar]])]),s("div",nt,[s("button",{class:"px-4 py-2 bg-green-600 text-white rounded disabled:opacity-60",disabled:v.value||!j.value,onClick:T},b(v.value?"Saving…":"Save Phase"),9,it)])]),_.value?(u(),c("div",ot,b(_.value),1)):R("",!0)]),s("div",rt,[s("div",{class:"flex items-center justify-between mb-4"},[t[11]||(t[11]=s("h3",{class:"text-lg font-semibold text-gray-800"},"Existing Phases",-1)),s("button",{onClick:y,class:"px-3 py-1.5 text-sm border rounded-lg hover:bg-gray-50"}," Refresh ")]),U.value?(u(),c("div",lt,"Loading…")):(u(),c("div",dt,[S.value.length?(u(),c("div",ct,[(u(!0),c(A,null,C(S.value,a=>(u(),c("div",{key:a.id,class:"group rounded-2xl overflow-hidden bg-white border border-gray-200/70 shadow-[0_1px_2px_rgba(0,0,0,0.04)] hover:shadow-[0_8px_24px_rgba(0,0,0,0.08)] hover:-translate-y-0.5 transition-all duration-200 p-4"},[s("div",pt,[s("div",vt,[s("span",bt,"#"+b(a.id),1)]),s("span",mt,b(a.status_label),1),s("button",{class:"ml-2 px-3 py-1.5 text-sm rounded-lg border border-red-200 text-red-700 bg-red-50 hover:bg-red-100",onClick:r=>L(a.id)}," Delete ",8,ft)]),s("div",yt,[s("div",null,[t[12]||(t[12]=s("label",{class:"block text-[11px] text-gray-500 mb-1"},"Status *",-1)),f(s("select",{"onUpdate:modelValue":r=>p[a.id].status=r,class:"form-input"},[(u(!0),c(A,null,C(D(d),r=>(u(),c("option",{key:r.value,value:r.value},b(r.label),9,xt))),128))],8,gt),[[I,p[a.id].status]])]),s("div",null,[t[13]||(t[13]=s("label",{class:"block text-[11px] text-gray-500 mb-1"},"Description (EN)",-1)),f(s("textarea",{"onUpdate:modelValue":r=>p[a.id].description.en=r,class:"form-input !h-auto min-h-9",rows:"1",onInput:t[3]||(t[3]=r=>V(r))},null,40,_t),[[w,p[a.id].description.en]])]),s("div",null,[t[14]||(t[14]=s("label",{class:"block text-[11px] text-gray-500 mb-1"},"Description (AR)",-1)),f(s("textarea",{"onUpdate:modelValue":r=>p[a.id].description.ar=r,class:"form-input !h-auto min-h-9",rows:"1",dir:"rtl",onInput:t[4]||(t[4]=r=>V(r))},null,40,ht),[[w,p[a.id].description.ar]])])]),s("div",kt,[s("button",{class:"px-3 py-1.5 text-sm rounded-lg border border-gray-300 bg-white hover:bg-gray-50 disabled:opacity-50",disabled:h[a.id],onClick:r=>F(a.id)},b(h[a.id]?"Saving…":"Save"),9,wt)])]))),128))])):(u(),c("div",ut," No phases found. "))]))])])]),_:1}))}},Vt=J(St,[["__scopeId","data-v-323a6310"]]);export{Vt as default};
