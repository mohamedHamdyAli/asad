import{l as k,i as V,m as x,r as E,p as L,c as O,o as u,w as M,b as s,f as c,h as R,j as y,F as A,q as C,u as P,t as f,y as D,s as S}from"./app-CdqcvLGQ.js";import{_ as q}from"./AuthenticatedLayout-CjS34vnV.js";import{_ as H}from"./_plugin-vue_export-helper-DlAUqK2U.js";const N=[{value:"site_handover",label:"Site Handover"},{value:"fondation",label:"Foundation"},{value:"finishing",label:"Finishing"},{value:"handover",label:"Handover"}];function J(t){try{return typeof t=="string"?JSON.parse(t):t}catch{return t}}function z(t){var n;return Array.isArray(t)?t:Array.isArray(t==null?void 0:t.data)?t.data:Array.isArray(t==null?void 0:t.message)?t.message:Array.isArray((n=t==null?void 0:t.data)==null?void 0:n.data)?t.data.data:[]}function G(t={}){var r;const n=J(t.description),d=n&&typeof n=="object"?n:{en:n??"",ar:n??""};return{id:t.id,unit_id:t.unit_id,status:t.status,status_label:((r=N.find(o=>o.value===t.status))==null?void 0:r.label)||t.status,desc_en:d.en??"",desc_ar:d.ar??"",created_at:t.created_at,updated_at:t.updated_at}}const _={statuses:()=>N,list:async t=>{const{data:n}=await k.get(`/api/unit-phase/${t}`);return z(n).map(G)},create:async t=>{const{data:n}=await k.post("/api/unit-phase/create",t);return n},update:async t=>{const{data:n}=await k.post("/api/unit-phase/update",t);return n},remove:async t=>{const{data:n}=await k.delete(`/api/unit-phase/delete/${t}`);return n}};function K(t,n=[]){return{unit_id:t,data:n.map(d=>{var r,o;return{status:d.status,description:{en:((r=d.description)==null?void 0:r.en)??"",ar:((o=d.description)==null?void 0:o.ar)??""}}})}}function Q(t,n=[]){return{unit_id:t,data:n.map(d=>{var o,v;const r={id:d.id};return d.status!==void 0&&(r.status=d.status),d.description&&(r.description={en:((o=d.description)==null?void 0:o.en)??"",ar:((v=d.description)==null?void 0:v.ar)??""}),r})}}const W={class:"p-6 space-y-6"},X={class:"flex items-center justify-between"},Y=["href"],Z={class:"bg-white p-4 rounded shadow"},tt={class:"grid grid-cols-1 md:grid-cols-4 gap-4"},et={class:"md:col-span-1"},st=["value"],at={class:"flex items-end"},nt=["disabled"],it={key:0,class:"mt-2 text-sm text-red-600"},ot={class:"bg-white p-4 rounded shadow"},dt={key:0,class:"text-sm text-gray-500"},lt={key:1},rt={key:0,class:"text-center text-gray-500 py-8"},ut={key:1,class:"grid grid-cols-1 lg:grid-cols-2 gap-4"},ct={class:"flex items-center justify-between mb-2"},pt={class:"font-semibold"},vt=["onClick"],ft={class:"grid grid-cols-1 md:grid-cols-3 gap-3 text-sm"},mt=["onUpdate:modelValue"],yt=["value"],bt=["onUpdate:modelValue"],xt=["onUpdate:modelValue"],_t={class:"mt-3"},gt=["disabled","onClick"],ht={__name:"Phases",props:{unitId:{type:[Number,String],required:!0}},setup(t){const n=t,d=V(()=>"/units-management"),r=_.statuses(),o=x({status:"",description:{en:"",ar:""}}),v=x(!1),g=x(""),j=V(()=>{var i,e;return!!o.value.status&&!!((i=o.value.description.en)!=null&&i.trim())&&!!((e=o.value.description.ar)!=null&&e.trim())});async function T(){var i,e;v.value=!0,g.value="";try{const a=K(n.unitId,[o.value]);await _.create(a),await b(),o.value={status:"",description:{en:"",ar:""}}}catch(a){console.error(a),g.value=((e=(i=a==null?void 0:a.response)==null?void 0:i.data)==null?void 0:e.message)||(a==null?void 0:a.message)||"Save failed"}finally{v.value=!1}}const U=x([]),w=x(!1),p=E({}),h=E({});function B(i){I(),i.forEach(e=>{p[e.id]={status:e.status,description:{en:e.desc_en||"",ar:e.desc_ar||""}}})}function I(){Object.keys(p).forEach(i=>delete p[i])}async function b(){w.value=!0;try{const i=await _.list(n.unitId);U.value=i,B(i)}finally{w.value=!1}}async function $(i){var a,l;const e=p[i];if(e){h[i]=!0;try{const m=Q(n.unitId,[{id:i,status:e.status,description:e.description}]);await _.update(m),await b()}catch(m){console.error(m),alert(((l=(a=m==null?void 0:m.response)==null?void 0:a.data)==null?void 0:l.message)||"Update failed")}finally{h[i]=!1}}}async function F(i){confirm("Delete this phase?")&&(await _.remove(i),await b())}return L(b),(i,e)=>(u(),O(q,null,{default:M(()=>[s("div",W,[s("div",X,[e[3]||(e[3]=s("h2",{class:"text-2xl font-bold text-gray-800"},"Unit Phases",-1)),s("a",{href:d.value,class:"px-3 py-1 border rounded"},"Back to Units",8,Y)]),s("div",Z,[e[8]||(e[8]=s("h3",{class:"text-lg font-bold mb-3"},"Add / Upsert Phase",-1)),s("div",tt,[s("div",et,[e[5]||(e[5]=s("label",{class:"block text-xs text-gray-500 mb-1"},"Status *",-1)),y(s("select",{"onUpdate:modelValue":e[0]||(e[0]=a=>o.value.status=a),class:"form-input"},[e[4]||(e[4]=s("option",{value:"",disabled:""},"Select status",-1)),(u(!0),c(A,null,C(P(r),a=>(u(),c("option",{key:a.value,value:a.value},f(a.label),9,st))),128))],512),[[D,o.value.status]])]),s("div",null,[e[6]||(e[6]=s("label",{class:"block text-xs text-gray-500 mb-1"},"Description (EN) *",-1)),y(s("input",{"onUpdate:modelValue":e[1]||(e[1]=a=>o.value.description.en=a),type:"text",class:"form-input"},null,512),[[S,o.value.description.en]])]),s("div",null,[e[7]||(e[7]=s("label",{class:"block text-xs text-gray-500 mb-1"},"Description (AR) *",-1)),y(s("input",{"onUpdate:modelValue":e[2]||(e[2]=a=>o.value.description.ar=a),type:"text",class:"form-input"},null,512),[[S,o.value.description.ar]])]),s("div",at,[s("button",{class:"px-4 py-2 bg-green-600 text-white rounded disabled:opacity-60",disabled:v.value||!j.value,onClick:T},f(v.value?"Saving…":"Save Phase"),9,nt)])]),g.value?(u(),c("div",it,f(g.value),1)):R("",!0)]),s("div",ot,[s("div",{class:"flex items-center justify-between mb-3"},[e[9]||(e[9]=s("h3",{class:"text-lg font-bold"},"Existing Phases",-1)),s("button",{onClick:b,class:"px-3 py-1 border rounded"},"Refresh")]),w.value?(u(),c("div",dt,"Loading…")):(u(),c("div",lt,[U.value.length?(u(),c("div",ut,[(u(!0),c(A,null,C(U.value,a=>(u(),c("div",{key:a.id,class:"border rounded p-3 bg-gray-50"},[s("div",ct,[s("div",pt,"#"+f(a.id)+" — "+f(a.status_label),1),s("button",{class:"px-2 py-1 border rounded text-red-600",onClick:l=>F(a.id)},"Delete",8,vt)]),s("div",ft,[s("div",null,[e[10]||(e[10]=s("label",{class:"block text-[11px] text-gray-500 mb-1"},"Status *",-1)),y(s("select",{"onUpdate:modelValue":l=>p[a.id].status=l,class:"form-input"},[(u(!0),c(A,null,C(P(r),l=>(u(),c("option",{key:l.value,value:l.value},f(l.label),9,yt))),128))],8,mt),[[D,p[a.id].status]])]),s("div",null,[e[11]||(e[11]=s("label",{class:"block text-[11px] text-gray-500 mb-1"},"Description (EN)",-1)),y(s("input",{"onUpdate:modelValue":l=>p[a.id].description.en=l,class:"form-input",type:"text"},null,8,bt),[[S,p[a.id].description.en]])]),s("div",null,[e[12]||(e[12]=s("label",{class:"block text-[11px] text-gray-500 mb-1"},"Description (AR)",-1)),y(s("input",{"onUpdate:modelValue":l=>p[a.id].description.ar=l,class:"form-input",type:"text"},null,8,xt),[[S,p[a.id].description.ar]])])]),s("div",_t,[s("button",{class:"px-3 py-1 border rounded",disabled:h[a.id],onClick:l=>$(a.id)},f(h[a.id]?"Saving…":"Save"),9,gt)])]))),128))])):(u(),c("div",rt,"No phases found."))]))])])]),_:1}))}},wt=H(ht,[["__scopeId","data-v-cd70c298"]]);export{wt as default};
